--------------------------------------------------------------------------------
-- Accounts and sessions

--
-- MUTABLE
Account
  username Username Maybe
  email Email
  password Sha256
  salt Salt
  customerId CustomerId
  subscribed Bool
  deriving Show

--
-- MUTABLE
Session
  uuid SessionUUID
  state SessionState
  nonce NonceUUID Maybe
  Unique UniqueUuid uuid
  deriving Show

--
-- MUTABLE
EarlyAccessRequest
  created UTCTime
  email Email
  approved UTCTime Maybe
  Unique EarlyAccessEmail email
  deriving Show

--------------------------------------------------------------------------------
-- Documents

-- A document has a unique slug and belongs to a single account.
--
-- MUTABLE
Document
  account AccountId
  name DocumentSlug
  created UTCTime
  updated UTCTime
  revision RevisionId Maybe
  deriving Show

-- Documents have many revisions with one active one, specified in the
-- Document relation.
--
-- APPEND-ONLY
Revision
  account AccountId
  document DocumentId
  created UTCTime
  deriving Show

-- A revision cell is created exactly after a revision, so we don't
-- store a creation date.
--
-- We associate `order' with this because it's about the document and
-- not about the cell.
--
-- APPEND-ONLY
RevisionCell
  revision RevisionId
  cell CellId
  order Int
  deriving Show

-- We put the name and creation time here because that's specific to a
-- cell.
--
-- Meanwhile, the same Cell can be used for multiple revisions, but
-- only for one document.
--
-- A user doesn't "edit" a cell; rather they create a new cell (and
-- therefore a new revision cell, and a new revision) with the same
-- contents slightly changed.
--
-- APPEND-ONLY
Cell
  account AccountId
  document DocumentId
  code CodeId
  created UTCTime
  name Text
  uuid UUID
  UniqueCell document code name uuid
  deriving Show

-- Independent from any specific document. It's just a piece of code
-- with a unique hash. We put the creation date to have some log of
-- where it came from.
--
-- They can be shared by multiple users or the same user across
-- different documents.
--
-- We ought to be able to garbage collect these like `git gc'.
--
-- APPEND-ONLY
Code
  source Text
  hash SHA512
  created UTCTime
  UniqueCode hash
  deriving Show

--------------------------------------------------------------------------------
-- Files

--
-- APPEND-ONLY
File
  account AccountId
  name Text
  created UTCTime
  hash Sha256
  bytes Word64
  mime Text
  deriving Show
