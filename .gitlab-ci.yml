stages:
  - build
  - release

build:
  image: registry.gitlab.com/sky-above/inflex/build@sha256:ea2a9e5b9b1b92e41e8b1ada0c062f72930b6f26c1bc0d3050e05948c5b4f3dd
  stage: build
  script:
    # - "stack test --fast"
    - "mkdir build"
    - "stack build --force-dirty --ghc-options=-O --copy-bins inflex-server --local-bin-path=build"
  artifacts:
    paths:
      - build

release:
  stage: release
  image: docker:stable
  services:
    - docker:dind
  dependencies:
    - build
  script:
    - docker login -u gitlab-ci-token -p "${CI_BUILD_TOKEN}" "${CI_REGISTRY}"
    - docker image build . -f docker/deploy.Dockerfile -t "${CI_REGISTRY_IMAGE}:pipeline-${CI_PIPELINE_ID}"
    - docker push "${CI_REGISTRY_IMAGE}:pipeline-${CI_PIPELINE_ID}"
