* Feature
** Shop
*** TODO Homepage
*** DONE Register page
    CLOSED: [2020-05-03 Sun 12:24]
    - State "DONE"       from "TODO"       [2020-05-03 Sun 12:24]
*** DONE Login/logout page
    CLOSED: [2020-05-03 Sun 12:24]
    - State "DONE"       from "TODO"       [2020-05-03 Sun 12:24]
*** TODO Yesod tests
** Database
*** DONE Create
    CLOSED: [2020-05-03 Sun 12:24]
    - State "DONE"       from "TODO"       [2020-05-03 Sun 12:24]
*** TODO Setup indexes
*** TODO Encrypt data at rest?
*** TODO Versioning?
** Organizer
** DONE List documents
   CLOSED: [2020-05-03 Sun 12:24]
   - State "DONE"       from "TODO"       [2020-05-03 Sun 12:24]
** DONE Create document
   CLOSED: [2020-05-03 Sun 12:24]
   - State "DONE"       from "TODO"       [2020-05-03 Sun 12:24]
** TODO Delete document
** TODO Rename
** UI
*** TODO [#B] Move arbitrarily
*** TODO [#B] Rename documents
*** TODO [#A] Re-use code instead of result for other array items
Repro:
[1, x] where x = 2 * 3
Changing 1 => 3 should not replace x with 6.
*** DONE [#B] Delete button
    CLOSED: [2020-05-03 Sun 12:16]
    - State "DONE"       from "TODO"       [2020-05-03 Sun 12:16]
*** DONE [#B] "New" button
    CLOSED: [2020-05-02 Sat 12:06]
    - State "DONE"       from "TODO"       [2020-05-02 Sat 12:06]
*** TODO Canvas/rendering?
    - Note taken on [2020-05-02 Sat 12:05] \\
      Mandelbrot in Excel https://slicker.me/fractals/excel.htm

      Make an equivalent in Inflex to show its speed/power?
*** TODO Code mirror?
    - Note taken on [2020-05-02 Sat 12:05] \\
      https://github.com/chrisdone/codeparty/blob/master/src/Halogen/CodeMirror.purs
** Engine
*** TODO Question-mark for results/optionals?
*** TODO Consider partial arithmetic similar to x * y :: Result Error Int
Be bold!

(but limited in memory use eventually)
Integer - arbitrary size   - total operations
Rational - arbitrary size  - total operations

(re-use safe-decimal package)
Int64 - fixed precision    - partial operations
Decimal - fixed precision  - partial operations

Int32/Int16/Int8

Use floating points but make partial results explicit too?
*** TODO [#C] Add TextE for String typed expressions
*** DONE [#A] Add Rows
    CLOSED: [2020-05-03 Sun 12:22]
    - State "DONE"       from "TODO"       [2020-05-03 Sun 12:22]
    - Note taken on [2020-04-27 Mon 15:57] \\
      Make sure that the real type Integer gets pushed up into the row
      type's field, instead of the variable:

      #+BEGIN_SRC haskell
      , Field
          { fieldName =
              Identifier
                { identifierString =
                    "y"
                }
          , fieldType =
              VariableType
                (TypeVariable
                   { typeVariableIdentifier =
                       ForallName
                         3
                   , typeVariableKind =
                       StarKind
                   })
          }
      #+END_SRC

      Oddly, it appears properly within the field (see below), so probably
      some more unification has to take place.

      #+BEGIN_SRC haskell
      InfixExpression
        (TypeSignature
           { typeSignatureA =
               Location
                 { locationStartLine = 0
                 , locationStartColumn = 0
                 , locationEndLine = 0
                 , locationEndColumn = 0
                 }
           , typeSignatureScheme =
               Forall
                 []
                 (Qualified
                    { qualifiedPredicates =
                        [ IsIn
                            (ClassName 13 "Num")
                            [ ConstructorType
                                (TypeConstructor
                                   { typeConstructorIdentifier =
                                       TypeName
                                         5
                                         "Integer"
                                   , typeConstructorKind =
                                       StarKind
                                   })
                            ]
                        ]
                    , qualifiedType =
                        ConstructorType
                          (TypeConstructor
                             { typeConstructorIdentifier =
                                 TypeName
                                   5
                                   "Integer"
                             , typeConstructorKind =
                                 StarKind
                             })
                    })
           })
      #+END_SRC
    - Note taken on [2020-04-26 Sun 16:01] \\
      Actually I think you need row poly anyway:

      #+BEGIN_SRC haskell
      x = { x: 1, y: "a" }
      #+END_SRC

      This can be inferred, because we already know the type of x.

      #+BEGIN_SRC haskell
      x.x
      #+END_SRC

      But we can't assign a type to this:

      #+BEGIN_SRC haskell
      f = \r -> r.x
      or even:
      count = \xs -> sum (filter .x xs)
      #+END_SRC

      What would its type be?

      #+BEGIN_SRC haskell
      f :: { x :: a | r } -> x   -- ?
      f :: Has "x" a r => r -> x -- ?
      #+END_SRC

      Probably best to just implement the row polymorphism anyway.
    - Note taken on [2020-04-25 Sat 17:33] \\
      Realization: let's just implement record types to start with, without
      the row polymorphism!

      Then we add row polymorphism later *when needed*.

      #+BEGIN_SRC haskell
      { a: 1, b: "foo" } :: { a :: Int, b :: String }
      #+END_SRC

      Easy peasy!

      Inference rules for this are less invasive than row poly. {} is of kind Type.

      Then we can easily have:

      #+BEGIN_SRC haskell
      [ { a: 1, b: "foo" }, { a: 2, b: "bar" } ] :: Array { a :: Int, b :: String }
      #+END_SRC
Notes:
- [X] Row type inference
- [X] Row type parsing
- [X] Row type renaming
- [X] Row type stepping
- [ ] Use test suite to test this
- [X] Add RowE display to Editor for row types
- [X] Add TableE (Vector (r :: Row)) display to Editor sum type
*** DONE [#A] Add Array
    CLOSED: [2020-03-14 Sat 16:27]
    - State "DONE"       from "TODO"       [2020-03-14 Sat 16:27]
   - Note taken on [2020-03-06 Fri 17:54] \\
     This will serve as a warm up for the Duet, for implementing row types.
   - Note taken on [2020-03-06 Fri 17:41] \\
     Work in progress. Needs inference for Array type.

e.g. data Array (a :: Type)
- [X] Add a Array type to Duet
- [X] Add inference for Array type
- [X] Add stepper for Array
- [X] Add a Array display to Editor sum type

#+BEGIN_SRC
[1,2,3]
=>
| 1 |
| 2 |
| 3 |
#+END_SRC
*** DONE Make sum type of results
   CLOSED: [2020-03-06 Fri 17:15]
   - Note taken on [2020-03-06 Fri 17:15] \\
     Made Editor type.

     #+BEGIN_SRC
     data Editor
       = IntegerE Integer
       -- | RationalE Rational
       -- | TextE Text
       -- | RecordE (HashMap Text Editor)
       -- | TableE (Array Text) (Array (HashMap Text Editor))
       | MiscE Text
       deriving (Show)
     #+END_SRC
   - State "DONE"       from "TODO"       [2020-03-06 Fri 17:15]
- [ ] Number
- [ ] List of numbers
- [ ] Table
- [ ] Text
*** DONE Get input value from Dec input
    CLOSED: [2020-02-29 Sat 15:27]
    - State "DONE"       from "TODO"       [2020-02-29 Sat 15:27]
*** DONE Make Haskell server load at runtime the app.js
    CLOSED: [2020-02-24 Mon 16:15]
    - State "DONE"       from "TODO"       [2020-02-24 Mon 16:15]
* Duet
** TODO [#C] Convert to trees that grow
** TODO [#A] Implement CAS name generation
- [ ] de Brujin index
- [ ] mutually recursive groups are rewritten into one

Quoting Unison:

#+BEGIN_QUOTE
A term or type definition that’s part of a cycle of mutually recursive
definitions hashes to the form #x.n where x is the hash of the cycle
and n is the term or type’s index in its cycle. A cycle has a
canonical order determined by sorting all the members of the cycle by
their individual hashes (with the cycle removed).
#+END_QUOTE
** TODO [#A] Get mappend xs ys for Array working
** TODO [#A] Rewrite Infer.hs module
** TODO [#B] Delete Alts and such
* Testing
  - Note taken on [2020-03-07 Sat 11:29] \\
    https://hackage.haskell.org/package/validity-0.9.0.3/docs/src/Data.Validity.html#trivialValidation
  - Note taken on [2020-03-07 Sat 11:26] \\
    #+BEGIN_QUOTE
    syd
    have you tried producesValidsOnValids?
    it's basically totality testing
    #+END_QUOTE
** TODO hspec-yesod to test shop
** TODO nodejs benchmark frontend
** TODO nodejs PureScript to unit test
** TODO Use PureScript to validity test QuickCheck generate code
- [ ] Should compile vs shouldn't -- if it compiles in PS implies it
  compiles in Duet
* Bugs
** UI
*** TODO [#C] Autoresize input to match content length
*** DONE [#C] Autofocus when starting the editor
    CLOSED: [2020-03-15 Sun 00:16]
    - State "DONE"       from "BLOCKED"    [2020-03-15 Sun 00:16]
    - State "BLOCKED"    from "TODO"       [2020-03-14 Sat 16:27] \\
      Waiting on answer.
    - Note taken on [2020-03-14 Sat 16:26] \\
      Asked question here:

      https://github.com/purescript-halogen/purescript-halogen/issues/646
* Supportive
** DONE Use psc-package-fast
   CLOSED: [2020-02-24 Mon 13:29]
   - State "DONE"       from "TODO"       [2020-02-24 Mon 13:29]
   - Note taken on [2020-02-24 Mon 13:29] \\
     Opened PR

     https://github.com/bitc/purescript-bundle-fast/pull/2

** DONE Put .psc-package in /dev/shm to avoid thrashing
   CLOSED: [2020-02-24 Mon 13:29]
   - State "DONE"       from "TODO"       [2020-02-24 Mon 13:29]

* Considerations
** TODO Lazy display of [infinite] data
** TODO Use streaming JSON parsers (defensive)
   - Note taken on [2020-04-11 Sat 23:42] \\
     https://github.com/chrisdone/streaming-parsers
** TODO Make WAI only approve of local subnet
   - Note taken on [2020-04-04 Sat 13:41] \\
     https://www.digitalocean.com/community/questions/how-to-set-a-ip-restriction-on-nodeport-range-of-do-managed-kubernetes?comment=86684
** TODO Username/organization blacklists!
https://www.quora.com/How-do-sites-prevent-vanity-URLs-from-colliding-with-future-features/answer/Kyle-Neath
** TODO GDPR
** TODO Sending emails?
** TODO Cache-control to make shop faster
   - Note taken on [2020-05-03 Sun 12:21] \\
     Immutible etc
** DONE The cookies spiel - needed before register/login page?
   CLOSED: [2020-04-14 Tue 11:42]
   - State "DONE"       from "TODO"       [2020-04-14 Tue 11:42]
   - Note taken on [2020-04-14 Tue 11:41] \\
     We can also just use server-side analysis with digital fingerprints to
     track people/funnelling. No cookies required.
   - Note taken on [2020-04-14 Tue 11:41] \\
     Nope - not needed for registration/signup.
** TODO Server-side PureScript
   - Note taken on [2020-03-06 Fri 16:20] \\
     Use nodejs for now?
   - Note taken on [2020-03-06 Fri 16:17] \\
     SpiderMonkey probably quite stable?
   - Note taken on [2020-03-05 Thu 09:37] \\
     V8 binary:

     #+BEGIN_SRC
     console.log('waiting');
     setTimeout(function(){
     console.log('hi');
     }, 1000 * 3);
     console.log('me first');
     $ ./d8 test.js
     waiting
     me first
     hi
     #+END_SRC
   - Note taken on [2020-03-05 Thu 09:37] \\
     Investigation into Duktape: https://github.com/svaarala/duktape/issues/2241
   - Note taken on [2020-03-04 Wed 15:26] \\
     Use one of these binaries?

     https://bellard.org/quickjs/bench.html

     NodeJS doesn't have a DOM anyway!
*** DONE review duktape [GOOD]
*** DONE Review hs-duktape [NOT GOOD]
    CLOSED: [2020-03-04 Wed 11:03]
    - State "DONE"       from "TODO"       [2020-03-04 Wed 11:03]
    - Note taken on [2020-03-04 Wed 11:02] \\
      Not very satisfying:

      https://github.com/myfreeweb/hs-duktape/issues/11
      https://github.com/myfreeweb/hs-duktape/issues/10
    - Note taken on [2020-03-04 Wed 11:01] \\
      https://github.com/myfreeweb/hs-duktape/pull/7/files
    - Note taken on [2020-03-04 Wed 10:47] \\
      https://github.com/svaarala/duktape/issues/1853
    - Note taken on [2020-03-04 Wed 10:31] \\
      https://github.com/myfreeweb/hs-duktape/commit/931f5da36454bfb9c6231333f82b14265fb226c8#r37628869
    - Note taken on [2020-03-04 Wed 10:31] \\
      https://github.com/myfreeweb/hs-duktape/commit/68b2ea59fb9c708362007acdc5cb35aca2b0d365
* Competition
** Notebooks
   - Note taken on [2020-03-07 Sat 16:51] \\
     What’s Wrong with Computational Notebooks?
     Pain Points, Needs, and Design Opportunities
     https://web.eecs.utk.edu/~azh/pubs/Chattopadhyay2020CHI_NotebookPainpoints.pdf
* Research
  - Note taken on [2020-03-26 Thu 09:33] \\
    https://www.unisonweb.org/
  - Note taken on [2020-03-26 Thu 09:33] \\
    https://www.reddit.com/r/haskell/comments/fov9gt/closure_calculus_is_better_than_the_pure_%CE%BBcalculus/fljg9fb/
* Mantras
** UI failures
- Scroll within scroll
- Focus stealing
* DigitalOcean
  - Note taken on [2020-04-14 Tue 10:55] \\
    externalTrafficPolicy is the key trick:

    http://64.227.44.55:30909/ =>

    #+BEGIN_SRC
    remoteHost = 109.175.148.125:56616,
    #+END_SRC

    https://inflex.io/ =>

    #+BEGIN_SRC
    remoteHost = 10.106.0.4:39350,
    #+END_SRC

    We can set an environment variable like ACCEPT_CIDR and make a Wai
    middleware which will only accept connections from IPs which are
    within that CIDR.
  - Note taken on [2020-04-04 Sat 10:29] \\
    Load balancer name issue:

    https://cloudsupport.digitalocean.com/s/my-tickets
  - Note taken on [2020-03-29 Sun 18:11] \\
    Consider e.g. rancher or coreos - a way to spin up a droplet with a
    single file like "run this docker image".
  - Note taken on [2020-03-29 Sun 17:45] \\
    Got a basic deploy working with DO's load balancer (with HTTPS), a
    single droplet (a heavy full ubuntu machine with docker-machine on
    it).

    Deploy step is basically:

    docker-machine up -d

    And we change the docker image to something else to deploy a new instance.
  - Note taken on [2020-03-29 Sun 17:10] \\
    Via docker-machine:

    time docker-machine create   --driver digitalocean   --digitalocean-access-token $(cat ~/.do-token)   --digitalocean-monitoring   --digitalocean-region "lon1"   --digitalocean-size "s-1vcpu-1gb" inflex-server
  - Note taken on [2020-03-29 Sun 12:36] \\
    Looks like this guy has it right:

    https://www.digitalocean.com/community/questions/kubernetes-deployment-with-external-load-balancer-zero-downtime-rollouts
- [ ] Proxying http://hackage.haskell.org/package/warp-3.3.9/docs/Network-Wai-Handler-Warp.html#v:setProxyProtocolRequired
#+BEGIN_SRC
chris@precision:~$ doctl auth init
Please authenticate doctl for use with your DigitalOcean account. You can generate a token in the control panel at https://cloud.digitalocean.com/account/api/token

Enter your access token:
Validating token... OK

chris@precision:~$ doctl kubernetes cluster kubeconfig save inflex-server
Notice: Adding cluster credentials to kubeconfig file found in "/home/chris/.kube/config"
Notice: Setting current-context to do-lon1-inflex-server
chris@precision:~$
#+END_SRC
